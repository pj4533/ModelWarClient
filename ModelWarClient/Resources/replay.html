<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Core War Battle Replay</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body {
    background: #1a1a2e;
    color: #e0e0e0;
    font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', system-ui, sans-serif;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    height: 100vh;
}
#status {
    text-align: center;
    padding: 8px;
    font-size: 12px;
    color: #88ccff;
    letter-spacing: 2px;
}
#canvas-container {
    flex: 1;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 4px;
}
canvas {
    display: block;
    image-rendering: pixelated;
    width: 100%;
    height: auto;
    max-height: 100%;
    object-fit: contain;
}
#controls {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 6px 12px;
    background: #0f0f1a;
    border-top: 1px solid #333;
    font-size: 11px;
}
#controls button {
    background: #2a2a4a;
    border: 1px solid #444;
    color: #e0e0e0;
    padding: 4px 12px;
    border-radius: 4px;
    cursor: pointer;
    font-size: 11px;
    font-family: inherit;
}
#controls button:hover { background: #3a3a5a; }
#controls button:disabled { opacity: 0.4; cursor: default; }
#btn-group { display: flex; gap: 4px; }
#info {
    display: flex;
    gap: 16px;
    font-family: 'SF Mono', 'Menlo', monospace;
    font-size: 11px;
}
.challenger-color { color: #39ff14; }
.defender-color { color: #ff00ff; }
#cycle-display { color: #88ccff; }
#progress-bar {
    width: 100%;
    height: 3px;
    background: #222;
}
#progress-fill {
    height: 100%;
    width: 0%;
    background: linear-gradient(90deg, #39ff14, #ff00ff);
    transition: width 0.05s linear;
}
#winner-banner {
    display: none;
    text-align: center;
    padding: 4px;
    font-size: 12px;
    font-weight: bold;
    letter-spacing: 2px;
}
</style>
</head>
<body>
<div id="status">WAITING FOR DATA...</div>
<div id="canvas-container">
    <canvas id="core" width="400" height="320"></canvas>
</div>
<div id="progress-bar"><div id="progress-fill"></div></div>
<div id="winner-banner"></div>
<div id="controls">
    <div id="btn-group">
        <button id="btn-play" disabled>Play</button>
        <button id="btn-step" disabled>Step</button>
        <button id="btn-end" disabled>End</button>
    </div>
    <div id="info">
        <span id="cycle-display">Cycle: 0</span>
        <span class="challenger-color" id="challenger-tasks">0</span>
        <span class="defender-color" id="defender-tasks">0</span>
    </div>
</div>

<script>
var PmarsTS=(()=>{var ge=Object.defineProperty;var Le=Object.getOwnPropertyDescriptor;var _e=Object.getOwnPropertyNames;var ve=Object.prototype.hasOwnProperty;var We=(o,e)=>{for(var t in e)ge(o,t,{get:e[t],enumerable:!0})},Ve=(o,e,t,s)=>{if(e&&typeof e=="object"||typeof e=="function")for(let r of _e(e))!ve.call(o,r)&&r!==t&&ge(o,r,{get:()=>e[r],enumerable:!(s=Le(e,r))||s.enumerable});return o};var Ue=o=>Ve(ge({},"__esModule",{value:!0}),o);var Be={};We(Be,{ADDRESS_MODE_SYMBOLS:()=>K,AddressMode:()=>p,Assembler:()=>me,CircularQueue:()=>se,Core:()=>te,DEFAULT_OPTIONS:()=>H,ExpressionEvaluator:()=>ne,INITIAL_INSTRUCTION:()=>Ie,MODIFIER_NAMES:()=>fe,Modifier:()=>l,OPCODE_NAMES:()=>J,Opcode:()=>E,PSpace:()=>ie,SimWarrior:()=>re,Simulator:()=>Re,addMod:()=>P,computePSpaceSize:()=>oe,createInstruction:()=>Ce,decodeOpcode:()=>ee,disassemble:()=>Ne,encodeOpcode:()=>pe,mulMod:()=>z,normalize:()=>B,rng:()=>$,subMod:()=>U});var E;(function(o){o[o.MOV=0]="MOV",o[o.ADD=1]="ADD",o[o.SUB=2]="SUB",o[o.MUL=3]="MUL",o[o.DIV=4]="DIV",o[o.MOD=5]="MOD",o[o.JMZ=6]="JMZ",o[o.JMN=7]="JMN",o[o.DJN=8]="DJN",o[o.CMP=9]="CMP",o[o.SLT=10]="SLT",o[o.SPL=11]="SPL",o[o.DAT=12]="DAT",o[o.JMP=13]="JMP",o[o.SEQ=14]="SEQ",o[o.SNE=15]="SNE",o[o.NOP=16]="NOP",o[o.LDP=17]="LDP",o[o.STP=18]="STP"})(E||(E={}));var l;(function(o){o[o.A=0]="A",o[o.B=1]="B",o[o.AB=2]="AB",o[o.BA=3]="BA",o[o.F=4]="F",o[o.X=5]="X",o[o.I=6]="I"})(l||(l={}));var p;(function(o){o[o.IMMEDIATE=0]="IMMEDIATE",o[o.DIRECT=1]="DIRECT",o[o.B_INDIRECT=2]="B_INDIRECT",o[o.B_PREDECR=3]="B_PREDECR",o[o.B_POSTINC=4]="B_POSTINC",o[o.A_INDIRECT=5]="A_INDIRECT",o[o.A_PREDECR=6]="A_PREDECR",o[o.A_POSTINC=7]="A_POSTINC"})(p||(p={}));var H={coreSize:8e3,maxCycles:8e4,maxLength:100,maxProcesses:8e3,minSeparation:100,readLimit:0,writeLimit:0,rounds:1,pSpaceSize:0,warriors:2,seed:null,fixedSeries:!1,fixedPosition:null},J=["MOV","ADD","SUB","MUL","DIV","MOD","JMZ","JMN","DJN","CMP","SLT","SPL","DAT","JMP","SEQ","SNE","NOP","LDP","STP"],fe=["A","B","AB","BA","F","X","I"],K=["#","$","@","<",">","*","{","}"];function pe(o,e){return(o<<3)+e}function ee(o){return{opcode:o>>3,modifier:o&7}}function Ce(o=E.DAT,e=l.F,t=p.DIRECT,s=0,r=p.DIRECT,i=0){return{opcode:pe(o,e),aMode:t,bMode:r,aValue:s,bValue:i}}var Ie=Object.freeze(Ce(E.DAT,l.F,p.DIRECT,0,p.DIRECT,0));var xe=36,ke=16;var te=class{constructor(e){this.size=e,this.memory=new Array(e),this.clear()}clear(){for(let e=0;e<this.size;e++)this.memory[e]={...Ie}}get(e){return this.memory[this.wrap(e)]}set(e,t){this.memory[this.wrap(e)]=t}copyFrom(e,t){let s=this.get(e),r=this.get(t);r.opcode=s.opcode,r.aMode=s.aMode,r.bMode=s.bMode,r.aValue=s.aValue,r.bValue=s.bValue}loadInstructions(e,t){for(let s=0;s<e.length;s++){let r=(t+s)%this.size;this.memory[r]={...e[s]}}}wrap(e){return(e%this.size+this.size)%this.size}};var se=class{constructor(e){this.capacity=e,this.buffer=new Array(e).fill(0),this.head=0,this.tail=0,this._size=0}push(e){this.buffer[this.tail]=e,this.tail=(this.tail+1)%this.capacity,this._size++}pop(){let e=this.buffer[this.head];return this.head=(this.head+1)%this.capacity,this._size--,e}peek(){return this.buffer[this.head]}get size(){return this._size}get empty(){return this._size===0}clear(){this.head=0,this.tail=0,this._size=0}toArray(){let e=[],t=this.head;for(let s=0;s<this._size;s++)e.push(this.buffer[t]),t=(t+1)%this.capacity;return e}};function P(o,e,t){let s=o+e;return s>=t?s-t:s}function U(o,e,t){let s=o-e;return s<0?s+t:s}function B(o,e){let t=o%e;return t<0&&(t+=e),t===0?0:t}function z(o,e,t){return o<94906265&&e<94906265?o*e%t:Number(BigInt(o)*BigInt(e)%BigInt(t))}var re=class{constructor(e,t,s,r,i){this.id=e,this.name=t.name||"Unknown",this.author=t.author||"Anonymous",this.processQueue=new se(s+1),this.position=0,this.startOffset=t.startOffset,this.tasks=0,this.score=new Array(r*2-1).fill(0),this.lastResult=i-1,this.pSpaceIndex=e,this.pSpaceIDNumber=t.pin??e,this.alive=!0}reset(e,t){this.processQueue.clear(),this.position=e,this.processQueue.push(B(e+this.startOffset,t)),this.tasks=1,this.alive=!0}pushProcess(e){this.processQueue.push(e)}popProcess(){return this.processQueue.pop()}getState(){return{id:this.id,name:this.name,author:this.author,tasks:this.tasks,processQueue:this.processQueue.toArray(),position:this.position,startOffset:this.startOffset,score:[...this.score],lastResult:this.lastResult,pSpaceIndex:this.pSpaceIndex,pSpaceIDNumber:this.pSpaceIDNumber,alive:this.alive}}};function oe(o){for(let e=ke;e>=1;e--)if(o%e===0)return Math.floor(o/e);return o}var ie=class{constructor(e,t){this.size=e,this.space=new Array(e).fill(0),this.lastResult=t-1}get(e){let t=(e%this.size+this.size)%this.size;return t===0?this.lastResult:this.space[t]}set(e,t){let s=(e%this.size+this.size)%this.size;s===0?this.lastResult=t:this.space[s]=t}clear(){this.space.fill(0),this.lastResult=0}clearKeepResult(){this.space.fill(0)}};function $(o){let e=o;return e=16807*(e%127773)-2836*Math.floor(e/127773),e<0&&(e+=2147483647),e}var Ae=20,ze=4;function we(o,e,t,s){let r=new Array(o).fill(0);if(o<=1)return{positions:r,seed:s};if(o===2){let h=e+1-2*t;return r[1]=t+s%h,s=$(s),{positions:r,seed:s}}let i=ye(o,e,t,s,r);return i.success?{positions:i.positions,seed:i.seed}:Fe(o,e,t,i.seed,r)}function ye(o,e,t,s,r){let i=1,h=Ae,n=ze;do{s=$(s),r[i]=s%(e-2*t+1)+t;let a=!1,u=i;for(let c=1;c<i;c++){let f=r[i]-r[c];if(f<0&&(f=-f),f<t){a=!0,u=c;break}}if(!a)i++;else{if(n===0)return{success:!1,positions:r,seed:s};h===0?(i=u,n--,h=Ae):h--}}while(i<o);return{success:!0,positions:r,seed:s}}function Fe(o,e,t,s,r){let i=e-t*o+1;for(let n=1;n<o;n++){s=$(s);let a=s%i,u;for(u=n-1;u>0&&!(a>r[u]);u--)r[u+1]=r[u];r[u+1]=a}let h=t;for(let n=1;n<o;n++)r[n]+=h,h+=t;for(let n=1;n<o;n++){s=$(s);let a=s%(o-n)+n,u=r[a];r[a]=r[n],r[n]=u}return{positions:r,seed:s}}var Re=class{constructor(e){this.warriors=[],this.warriorData=[],this.pSpaces=[],this.listener=null,this.currentWarriorIdx=0,this.warriorsLeft=0,this.cycle=0,this.roundNum=0,this.totalCycles=0,this.seed=0,this.initialized=!1,this.nextWarrior=[],this.prevWarrior=[],this.coreAccessEvents=[],this.options={...H,...e},this.core=new te(this.options.coreSize)}setEventListener(e){this.listener=e}loadWarriors(e){if(e.length>xe)throw new Error(`Maximum ${xe} warriors supported`);if(this.options.fixedSeries&&this.options.fixedPosition!=null)throw new Error("fixedSeries and fixedPosition are mutually exclusive");this.warriorData=e;let t=this.options.coreSize;if(this.options.minSeparation=Math.max(this.options.minSeparation,this.options.maxLength),e.length>1&&t<e.length*this.options.minSeparation&&(this.options.minSeparation=Math.floor(t/e.length)),this.options.fixedPosition!=null&&this.options.fixedPosition<this.options.minSeparation)throw new Error(`fixedPosition (${this.options.fixedPosition}) must be >= minSeparation (${this.options.minSeparation})`);this.warriors=e.map((r,i)=>new re(i,r,this.options.maxProcesses,e.length,t));let s=this.options.pSpaceSize>0?this.options.pSpaceSize:oe(t);this.pSpaces=e.map(()=>new ie(s,t));for(let r=0;r<e.length;r++)if(e[r].pin!==null){for(let i=0;i<r;i++)if(e[i].pin!==null&&e[i].pin===e[r].pin){this.warriors[r].pSpaceIndex=i;break}}this.initialized=!0}run(e){let t=e??this.options.rounds,s=[];for(let r=0;r<t;r++)s.push(this.runRound());return s}runRound(){for(this.setupRound();this.cycle>0&&this.warriorsLeft>=2;)this.executeOneCycle();return this.endRound()}setupRound(){if(!this.initialized||this.warriors.length===0)throw new Error("Simulator not initialized. Call loadWarriors() first.");this.core.clear(),this.roundNum++,this.roundNum===1&&(this.options.fixedPosition!=null?this.seed=this.options.fixedPosition-this.options.minSeparation:(this.options.fixedSeries?this.seed=this.checksumWarriors():this.seed=this.options.seed??this.checksumWarriors(),this.seed=$(this.seed)));let{positions:e,seed:t}=we(this.warriors.length,this.options.coreSize,this.options.minSeparation,this.seed);this.seed=t,this.warriorsLeft=this.warriors.length,this.totalCycles=this.warriors.length*this.options.maxCycles,this.cycle=this.totalCycles,this.nextWarrior=new Array(this.warriors.length),this.prevWarrior=new Array(this.warriors.length);for(let s=0;s<this.warriors.length;s++)this.warriors[s].position=e[s],this.warriors[s].reset(e[s],this.options.coreSize),this.core.loadInstructions(this.warriorData[s].instructions,e[s]),this.nextWarrior[s]=(s+1)%this.warriors.length,this.prevWarrior[s]=(s-1+this.warriors.length)%this.warriors.length;this.currentWarriorIdx=(this.roundNum-1)%this.warriors.length}step(){return this.cycle<=0||this.warriorsLeft<2?this.endRound():(this.executeOneCycle(),this.cycle<=0||this.warriorsLeft<2?this.endRound():null)}executeOneCycle(){let e=this.warriors[this.currentWarriorIdx],t=this.options.coreSize,s=t-1,r=e.popProcess(),i=this.core.get(r),h=i.opcode,n=i.aMode,a=i.bMode,u=i.aValue,c=i.bValue;this.coreAccessEvents.length=0,this.emitCoreAccess(e.id,r,"EXECUTE");let f,b;if(n!==p.IMMEDIATE)if(f=this.foldr(r+u,r),n!==p.DIRECT){let R,m=!1,g=f;n===p.A_INDIRECT||n===p.A_PREDECR||n===p.A_POSTINC?(m=!0,n!==p.A_INDIRECT?(g=this.foldw(r+u,r),R=this.core.get(g).aValue):(this.emitCoreAccess(e.id,f,"READ"),R=this.core.get(f).aValue)):n!==p.B_INDIRECT?(g=this.foldw(r+u,r),R=this.core.get(g).bValue):(this.emitCoreAccess(e.id,f,"READ"),R=this.core.get(f).bValue),(n===p.B_PREDECR||n===p.A_PREDECR)&&(R--,R<0&&(R=s),m?this.core.get(g).aValue=R:this.core.get(g).bValue=R);let V=n!==p.A_INDIRECT&&n!==p.B_INDIRECT?g:f;f=this.foldr(V+R,r),b=this.core.get(f).aValue,u=this.core.get(f).bValue,(n===p.B_POSTINC||n===p.A_POSTINC)&&(R++,R===t&&(R=0),m?this.core.get(g).aValue=R:this.core.get(g).bValue=R)}else{let R=this.core.get(f);b=R.aValue,u=R.bValue}else b=u,f=r,u=c;let d,x,T;if(a!==p.IMMEDIATE){x=this.foldr(r+c,r),d=this.foldw(r+c,r);let R=d;if(a!==p.DIRECT){let m,g=!1;a===p.A_INDIRECT||a===p.A_PREDECR||a===p.A_POSTINC?(g=!0,a!==p.A_INDIRECT?m=this.core.get(d).aValue:(this.emitCoreAccess(e.id,x,"READ"),m=this.core.get(x).aValue)):a!==p.B_INDIRECT?m=this.core.get(d).bValue:(this.emitCoreAccess(e.id,x,"READ"),m=this.core.get(x).bValue),(a===p.B_PREDECR||a===p.A_PREDECR)&&(m--,m<0&&(m=s),g?this.core.get(d).aValue=m:this.core.get(d).bValue=m);let V=a!==p.A_INDIRECT&&a!==p.B_INDIRECT?d:x;d=this.foldw(d+m,r),x=this.foldr(V+m,r),T=this.core.get(x).aValue,c=this.core.get(x).bValue,(a===p.B_POSTINC||a===p.A_POSTINC)&&(m++,m===t&&(m=0),g?this.core.get(R).aValue=m:this.core.get(R).bValue=m)}else{let m=this.core.get(x);T=m.aValue,c=m.bValue}}else d=r,x=r,c=this.core.get(d).bValue,T=this.core.get(d).aValue;let{opcode:w,modifier:D}=ee(h),I=!0,O=P(r,1,t),A=!1;switch(w){case E.MOV:this.execMOV(D,f,d,b,u,T,c,e.id);break;case E.ADD:this.execADD(D,f,d,b,u,T,c,t,e.id);break;case E.SUB:this.execSUB(D,f,d,b,u,T,c,t,e.id);break;case E.MUL:this.execMUL(D,f,d,b,u,T,c,t,e.id);break;case E.DIV:A=this.execDIV(D,f,d,b,u,T,c,t,e.id);break;case E.MOD:A=this.execMOD(D,f,d,b,u,T,c,t,e.id);break;case E.JMP:e.pushProcess(f),I=!1;break;case E.JMZ:this.checkJMZ(D,T,c)&&(e.pushProcess(f),I=!1);break;case E.JMN:this.checkJMN(D,T,c)&&(e.pushProcess(f),I=!1);break;case E.DJN:this.execDJN(D,f,d,T,c,s,e.id)&&(e.pushProcess(f),I=!1);break;case E.CMP:case E.SEQ:this.checkCMP(D,f,x,b,u,T,c)&&(O=P(r,2,t));break;case E.SNE:this.checkCMP(D,f,x,b,u,T,c)||(O=P(r,2,t));break;case E.SLT:this.checkSLT(D,b,u,T,c)&&(O=P(r,2,t));break;case E.SPL:e.pushProcess(O),e.tasks<this.options.maxProcesses&&(e.tasks++,e.pushProcess(f)),I=!1;break;case E.DAT:A=!0;break;case E.NOP:break;case E.LDP:this.execLDP(D,f,d,b,u,e,t);break;case E.STP:this.execSTP(D,f,d,b,u,T,c,e,t);break}A&&(e.tasks--,e.tasks<=0?(e.alive=!1,e.score[this.warriorsLeft+this.warriors.length-2]++,this.cycle=this.cycle-1-Math.floor((this.cycle-1)/this.warriorsLeft),this.warriorsLeft--,this.nextWarrior[this.prevWarrior[this.currentWarriorIdx]]=this.nextWarrior[this.currentWarriorIdx],this.prevWarrior[this.nextWarrior[this.currentWarriorIdx]]=this.prevWarrior[this.currentWarriorIdx],this.currentWarriorIdx=this.nextWarrior[this.currentWarriorIdx]):I=!1),I&&!A&&e.pushProcess(O),this.listener?.onCoreAccess&&this.coreAccessEvents.length>0&&this.listener.onCoreAccess(this.coreAccessEvents),this.listener?.onTaskCount&&this.listener.onTaskCount(this.warriors.filter(R=>R.alive).map(R=>({warriorId:R.id,taskCount:R.tasks}))),e.alive&&(this.currentWarriorIdx=this.nextWarrior[this.currentWarriorIdx]),this.cycle--}endRound(){let e=null,t="TIE";for(let r of this.warriors)r.alive?(r.score[this.warriorsLeft-1]++,r.lastResult=this.warriorsLeft,this.pSpaces[r.pSpaceIndex].lastResult=this.warriorsLeft):(r.lastResult=0,this.pSpaces[r.pSpaceIndex].lastResult=0);if(this.warriorsLeft===1){let r=this.warriors.find(i=>i.alive);r&&(e=r.id,t="WIN")}let s={winnerId:e,outcome:t};return this.listener?.onRoundEnd&&this.listener.onRoundEnd({winnerId:e}),s}checksumWarriors(){let e=0,t=0;for(let s of this.warriorData)for(let r of s.instructions)e=e+(r.opcode^t++)|0,e=e+(r.aMode^t++)|0,e=e+(r.bMode^t++)|0,e=e+(r.aValue^t++)|0,e=e+(r.bValue^t++)|0;return e}foldr(e,t){let s=this.options.coreSize;if(this.options.readLimit===0)return(e%s+s)%s;let r=this.options.readLimit,i=(e+s-t)%r;return i>Math.floor(r/2)&&(i=i+s-r),P(i,t,s)}foldw(e,t){let s=this.options.coreSize;if(this.options.writeLimit===0)return(e%s+s)%s;let r=this.options.writeLimit,i=(e+s-t)%r;return i>Math.floor(r/2)&&(i=i+s-r),P(i,t,s)}emitCoreAccess(e,t,s){this.listener?.onCoreAccess&&this.coreAccessEvents.push({warriorId:e,address:t,accessType:s})}execMOV(e,t,s,r,i,h,n,a){this.emitCoreAccess(a,t,"READ");let u=this.core.get(s);switch(e){case l.A:u.aValue=r;break;case l.B:u.bValue=i;break;case l.AB:u.bValue=r;break;case l.BA:u.aValue=i;break;case l.F:u.aValue=r,u.bValue=i;break;case l.X:u.bValue=r,u.aValue=i;break;case l.I:{let c=this.core.get(t);u.opcode=c.opcode,u.aMode=c.aMode,u.bMode=c.bMode,u.aValue=r,u.bValue=i;break}}this.emitCoreAccess(a,s,"WRITE")}execADD(e,t,s,r,i,h,n,a,u){this.emitCoreAccess(u,t,"READ");let c=this.core.get(s);switch(e){case l.A:c.aValue=P(h,r,a);break;case l.B:c.bValue=P(n,i,a);break;case l.AB:c.bValue=P(n,r,a);break;case l.BA:c.aValue=P(h,i,a);break;case l.F:case l.I:c.aValue=P(h,r,a),c.bValue=P(n,i,a);break;case l.X:c.bValue=P(n,r,a),c.aValue=P(h,i,a);break}this.emitCoreAccess(u,s,"WRITE")}execSUB(e,t,s,r,i,h,n,a,u){this.emitCoreAccess(u,t,"READ");let c=this.core.get(s);switch(e){case l.A:c.aValue=U(h,r,a);break;case l.B:c.bValue=U(n,i,a);break;case l.AB:c.bValue=U(n,r,a);break;case l.BA:c.aValue=U(h,i,a);break;case l.F:case l.I:c.aValue=U(h,r,a),c.bValue=U(n,i,a);break;case l.X:c.bValue=U(n,r,a),c.aValue=U(h,i,a);break}this.emitCoreAccess(u,s,"WRITE")}execMUL(e,t,s,r,i,h,n,a,u){this.emitCoreAccess(u,t,"READ");let c=this.core.get(s);switch(e){case l.A:c.aValue=z(h,r,a);break;case l.B:c.bValue=z(n,i,a);break;case l.AB:c.bValue=z(n,r,a);break;case l.BA:c.aValue=z(h,i,a);break;case l.F:case l.I:c.aValue=z(h,r,a),c.bValue=z(n,i,a);break;case l.X:c.bValue=z(n,r,a),c.aValue=z(h,i,a);break}this.emitCoreAccess(u,s,"WRITE")}execDIV(e,t,s,r,i,h,n,a,u){this.emitCoreAccess(u,t,"READ");let c=this.core.get(s);switch(e){case l.A:if(r===0)return!0;c.aValue=Math.floor(h/r);break;case l.B:if(i===0)return!0;c.bValue=Math.floor(n/i);break;case l.AB:if(r===0)return!0;c.bValue=Math.floor(n/r);break;case l.BA:if(i===0)return!0;c.aValue=Math.floor(h/i);break;case l.F:case l.I:if(r!==0){if(c.aValue=Math.floor(h/r),this.emitCoreAccess(u,s,"WRITE"),i===0)return!0;c.bValue=Math.floor(n/i)}else return i===0||(c.bValue=Math.floor(n/i),this.emitCoreAccess(u,s,"WRITE")),!0;break;case l.X:if(i!==0){if(c.aValue=Math.floor(h/i),this.emitCoreAccess(u,s,"WRITE"),r===0)return!0;c.bValue=Math.floor(n/r)}else return r===0||(c.bValue=Math.floor(n/r),this.emitCoreAccess(u,s,"WRITE")),!0;break}return this.emitCoreAccess(u,s,"WRITE"),!1}execMOD(e,t,s,r,i,h,n,a,u){this.emitCoreAccess(u,t,"READ");let c=this.core.get(s);switch(e){case l.A:if(r===0)return!0;c.aValue=h%r;break;case l.B:if(i===0)return!0;c.bValue=n%i;break;case l.AB:if(r===0)return!0;c.bValue=n%r;break;case l.BA:if(i===0)return!0;c.aValue=h%i;break;case l.F:case l.I:if(r!==0){if(c.aValue=h%r,this.emitCoreAccess(u,s,"WRITE"),i===0)return!0;c.bValue=n%i}else return i===0||(c.bValue=n%i,this.emitCoreAccess(u,s,"WRITE")),!0;break;case l.X:if(i!==0){if(c.aValue=h%i,this.emitCoreAccess(u,s,"WRITE"),r===0)return!0;c.bValue=n%r}else return r===0||(c.bValue=n%r,this.emitCoreAccess(u,s,"WRITE")),!0;break}return this.emitCoreAccess(u,s,"WRITE"),!1}checkJMZ(e,t,s){switch(e){case l.A:case l.BA:return t===0;case l.B:case l.AB:return s===0;case l.F:case l.X:case l.I:return t===0&&s===0;default:{let r=e;throw new Error(`Unexpected modifier: ${r}`)}}}checkJMN(e,t,s){switch(e){case l.A:case l.BA:return t!==0;case l.B:case l.AB:return s!==0;case l.F:case l.X:case l.I:return t!==0||s!==0;default:{let r=e;throw new Error(`Unexpected modifier: ${r}`)}}}execDJN(e,t,s,r,i,h,n){let a=this.core.get(s);switch(e){case l.A:case l.BA:return a.aValue--,a.aValue<0&&(a.aValue=h),this.emitCoreAccess(n,s,"WRITE"),r!==1;case l.B:case l.AB:return a.bValue--,a.bValue<0&&(a.bValue=h),this.emitCoreAccess(n,s,"WRITE"),i!==1;case l.F:case l.I:case l.X:return a.bValue--,a.bValue<0&&(a.bValue=h),a.aValue--,a.aValue<0&&(a.aValue=h),this.emitCoreAccess(n,s,"WRITE"),!(r===1&&i===1);default:{let u=e;throw new Error(`Unexpected modifier: ${u}`)}}}checkCMP(e,t,s,r,i,h,n){switch(e){case l.A:return h===r;case l.B:return n===i;case l.AB:return n===r;case l.BA:return h===i;case l.F:return h===r&&n===i;case l.X:return n===r&&h===i;case l.I:{let a=this.core.get(t),u=this.core.get(s);return a.opcode===u.opcode&&a.aMode===u.aMode&&a.bMode===u.bMode&&r===h&&i===n}default:{let a=e;throw new Error(`Unexpected modifier: ${a}`)}}}checkSLT(e,t,s,r,i){switch(e){case l.A:return t<r;case l.B:return s<i;case l.AB:return t<i;case l.BA:return s<r;case l.F:case l.I:return t<r&&s<i;case l.X:return t<i&&s<r;default:{let h=e;throw new Error(`Unexpected modifier: ${h}`)}}}execLDP(e,t,s,r,i,h,n){let a=this.pSpaces[h.pSpaceIndex],u=this.core.get(s),c=f=>f%a.size===0?h.lastResult:a.get(f);switch(e){case l.A:u.aValue=c(r);break;case l.B:case l.F:case l.X:case l.I:u.bValue=c(i);break;case l.AB:u.bValue=c(r);break;case l.BA:u.aValue=c(i);break}this.emitCoreAccess(h.id,s,"WRITE")}execSTP(e,t,s,r,i,h,n,a,u){let c=this.pSpaces[a.pSpaceIndex],f=(b,d)=>{b%c.size===0?a.lastResult=d:c.set(b,d)};switch(e){case l.A:f(h,r);break;case l.B:case l.F:case l.X:case l.I:f(n,i);break;case l.AB:f(n,r);break;case l.BA:f(h,i);break}}getCore(){return this.core}getWarriors(){return this.warriors}};function Te(o){return o===42||o===47||o===37?5:o===43||o===45?4:o===62||o===60||o===128||o===129||o===130||o===131?3:o===132?2:o===133?1:0}function $e(o){return o===")"||o===""||o===void 0}var Me=256,ne=class{constructor(){this.registers=new Array(26).fill(0),this.saveOper=0,this.error=null}resetRegisters(){this.registers.fill(0)}setRegister(e,t){let s=e.toUpperCase().charCodeAt(0)-65;s>=0&&s<26&&(this.registers[s]=t)}evaluate(e){this.error=null,this.saveOper=0;let t={pos:0,src:e.trim()},s=this.evalExpr(t,-1,0,127,0);return this.skipSpace(t),t.pos<t.src.length?{ok:!1,error:"BAD_EXPR"}:this.error==="OVERFLOW"?{ok:!0,value:s,overflow:!0}:this.error?{ok:!1,error:this.error}:{ok:!0,value:s,overflow:!1}}evalExpr(e,t,s,r,i){if(i>Me)return this.error="BAD_EXPR",0;this.saveOper=0;let h=this.getVal(e,i);if(this.skipSpace(e),$e(e.src[e.pos]))return this.calc(s,h,r);let n=this.getOp(e),a=Te(r),u=Te(n);if(a>=u)return u>t?this.evalExpr(e,t,this.calc(s,h,r),n,i+1):(this.saveOper=n,this.calc(s,h,r));{let c=this.evalExpr(e,a,h,n,i+1),f=this.calc(s,c,r);return this.saveOper&&Te(this.saveOper)>=t&&(f=this.evalExpr(e,t,f,this.saveOper,i+1)),f}}getVal(e,t){if(t>Me)return this.error="BAD_EXPR",0;this.skipSpace(e);let s=e.src[e.pos];if(s==="("){e.pos++;let h=this.evalExpr(e,-1,0,127,t+1);return e.src[e.pos]!==")"&&(this.error="BAD_EXPR"),e.pos++,h}if(s==="-")return e.pos++,-this.getVal(e,t+1);if(s==="!")return e.pos++,this.getVal(e,t+1)?0:1;if(s==="+")return e.pos++,this.getVal(e,t+1);let r=s?.toUpperCase();if(r&&r>="A"&&r<="Z"){e.pos++;let h=r.charCodeAt(0)-65;if(this.skipSpace(e),e.src[e.pos]==="="&&e.src[e.pos+1]!=="="){e.pos++;let n=this.evalExpr(e,-1,0,127,t+1);return this.registers[h]=n,n}return this.registers[h]}let i="";for(;e.pos<e.src.length&&e.src[e.pos]>="0"&&e.src[e.pos]<="9"&&i.length<20;)i+=e.src[e.pos],e.pos++;return i.length===0?(this.error="BAD_EXPR",0):parseInt(i,10)}getOp(e){let t=e.src[e.pos];switch(e.pos++,t){case"&":return e.src[e.pos]==="&"?(e.pos++,132):t.charCodeAt(0);case"|":return e.src[e.pos]==="|"?(e.pos++,133):t.charCodeAt(0);case"=":return e.src[e.pos]==="="?(e.pos++,128):t.charCodeAt(0);case"!":return e.src[e.pos]==="="?(e.pos++,129):t.charCodeAt(0);case"<":return e.src[e.pos]==="="?(e.pos++,131):t.charCodeAt(0);case">":return e.src[e.pos]==="="?(e.pos++,130):t.charCodeAt(0);default:return t.charCodeAt(0)}}checkOverflow(e){return(e>2147483647||e<-2147483648)&&(this.error="OVERFLOW"),e}calc(e,t,s){switch(s){case 43:return this.checkOverflow(e+t);case 45:return this.checkOverflow(e-t);case 42:return this.checkOverflow(e*t);case 47:return t===0?(this.error="DIV_ZERO",0):Math.trunc(e/t);case 37:return t===0?(this.error="DIV_ZERO",0):e%t;case 132:return e&&t?1:0;case 133:return e||t?1:0;case 128:return e===t?1:0;case 129:return e!==t?1:0;case 60:return e<t?1:0;case 62:return e>t?1:0;case 131:return e<=t?1:0;case 130:return e>=t?1:0;case 127:return t;default:return this.error="BAD_EXPR",0}}skipSpace(e){for(;e.pos<e.src.length;){let t=e.src[e.pos];if(t===" "||t==="	"||t===`
`||t==="\r"||t==="\f"||t==="\v")e.pos++;else break}}};var me=class{constructor(e){this.options=e??{},this.evaluator=new ne}assemble(e){let t={...H,...this.options},s=[],r=e.split(`
`),i=[],h="";for(let C of r){let k=C.indexOf(";"),Q=k>=0?C.substring(0,k):C;Q.trimEnd().endsWith("\\")?h+=Q.trimEnd().slice(0,-1):(i.push(h+C),h="")}h&&i.push(h);let n="Unknown",a="Anonymous",u="",c=null,f=0,b=null,d=null,x=null,T=null,w=new Map,D=[];this.evaluator.resetRegisters();let I=new Map;I.set("CORESIZE",t.coreSize),I.set("MAXPROCESSES",t.maxProcesses),I.set("MAXCYCLES",t.maxCycles),I.set("MAXLENGTH",t.maxLength),I.set("MINDISTANCE",t.minSeparation),I.set("VERSION",96),I.set("WARRIORS",t.warriors),I.set("ROUNDS",t.rounds),I.set("PSPACESIZE",t.pSpaceSize>0?t.pSpaceSize:oe(t.coreSize)),I.set("READLIMIT",t.readLimit||t.coreSize),I.set("WRITELIMIT",t.writeLimit||t.coreSize);let O=0,A=new Map,R=new Map,m=0,g=null,V=new Set,Ee=!1,de=!1,M=null,X=!1;for(let C=0;C<i.length;C++){let k=i[C],Q=k;if(de)break;let ae=k.trim();if(ae.startsWith(";")){let S=ae.substring(1).trim(),N=S.toUpperCase();if(N.startsWith("REDCODE")){Ee?de=!0:(Ee=!0,D.length=0,O=0,w.clear(),A.clear(),R.clear(),n="Unknown",a="Anonymous",u="",c=null,f=0,b=null,M=null);continue}if(N.startsWith("NAME")){n=S.substring(4).trim()||"Unknown",M=null;continue}if(N.startsWith("AUTHOR")){a=S.substring(6).trim()||"Anonymous",M=null;continue}if(N.startsWith("STRATEGY")){u+=(u?`
`:"")+S.substring(8).trim(),M=null;continue}if(N.startsWith("ASSERT")){X=!0;let v=S.substring(6).trim();if(v){let ue=this.substituteEqus(v,A,I),ce=this.evaluator.evaluate(ue);ce.ok&&ce.value===0&&s.push({type:"ERROR",line:C+1,text:`Assertion failed: ${v}`})}M=null;continue}continue}let De=k.indexOf(";");if(De>=0&&(k=k.substring(0,De)),k=k.trim(),k.length===0)continue;if(g){let S=k.toUpperCase().trim();if(S.startsWith("ROF")&&(m--,m===0)){let N=this.expandNestedFor(g.lines,A,I);for(let v=1;v<=g.count;v++){g.label&&(A.set(g.label,String(v)),V.add(g.label));for(let ue of N){I.set("CURLINE",O);let ce=this.substituteAmpersand(ue,A,I,V),Y=this.tokenizeLine(ce),Z=0,le=null;for(;Z<Y.length;){let he=Y[Z].toUpperCase();if(this.isOpcode(he)||he==="EQU")break;let be=Y[Z];be.endsWith(":")&&(be=be.slice(0,-1)),le=be.toUpperCase(),Z++}if(Z<Y.length&&Y[Z].toUpperCase()==="EQU"&&le){let he=Y.slice(Z+1).join(" ");A.set(le,he),w.set(le,{name:le,value:0,isEqu:!0,equText:he});continue}D.push({line:C+1,text:ce,rawLine:Q}),O++}}g.label&&(A.delete(g.label),V.delete(g.label)),g=null,M=null;continue}S.startsWith("FOR")&&m++,g.lines.push(k);continue}let F=null,Se=[],Oe=k,L=this.tokenizeLine(Oe);if(L.length===0)continue;let _=0;for(;_<L.length;){let S=L[_].toUpperCase();if(this.isOpcode(S)||S==="EQU"||S==="FOR"||S==="ROF"||S==="END"||S==="ORG"||S==="PIN")break;let N=L[_];N.endsWith(":")&&(N=N.slice(0,-1)),F=N.toUpperCase(),Se.push(F),_++}if(_>=L.length){for(let S of Se)w.set(S,{name:S,value:O,isEqu:!1});M=null;continue}let j=L[_].toUpperCase();if(j==="EQU"){if(F){let S=L.slice(_+1).join(" ");A.set(F,S),w.set(F,{name:F,value:0,isEqu:!0,equText:S}),R.set(F,[S]),M=F}else if(M){let S=L.slice(_+1).join(" "),N=R.get(M)||[];N.push(S),R.set(M,N);let v=w.get(M);v&&(v.equLines=N)}else s.push({type:"ERROR",line:C+1,text:"EQU without label"}),M=null;continue}if(M=null,j==="ROF"){s.push({type:"WARNING",line:C+1,text:"ROF without matching FOR"});continue}if(j==="FOR"){let S=L.slice(_+1).join(" "),N=this.substituteEqus(S,A,I),v=this.evaluator.evaluate(N),ue=(v.ok?v.value:0)&65535;g={label:F,count:ue,lines:[]},m=1;continue}if(j==="ORG"){d={expr:L.slice(_+1).join(" "),lineNum:C+1};continue}if(j==="END"){let S=L.slice(_+1).join(" ");S.trim()&&(x={expr:S,lineNum:C+1});break}if(j==="PIN"){T={expr:L.slice(_+1).join(" "),lineNum:C+1};continue}for(let S of Se)w.set(S,{name:S,value:O,isEqu:!1});let Pe=L.slice(_).join(" ");D.push({line:C+1,text:Pe,rawLine:Q}),O++}if(d){let C=this.substituteLabelsAndEqusAbsolute(d.expr,w,A,I),k=this.evaluator.evaluate(C);k.ok&&(f=k.value)}if(x){let C=this.substituteLabelsAndEqusAbsolute(x.expr,w,A,I),k=this.evaluator.evaluate(C);k.ok&&k.value!==0&&(f!==0&&d?s.push({type:"WARNING",line:x.lineNum,text:"END offset ignored, ORG already set"}):f===0&&(b=k.value))}if(T){let C=this.substituteLabelsAndEqusAbsolute(T.expr,w,A,I),k=this.evaluator.evaluate(C);k.ok&&(c=k.value)}g&&s.push({type:"WARNING",line:0,text:"Unclosed FOR block (missing ROF)"}),b!==null&&f===0&&(f=b),X||s.push({type:"WARNING",line:0,text:"Missing ASSERT"});let G=this.expandMultiLineEqus(D,R),y=G.length;if(y===0)return s.push({type:"ERROR",line:0,text:"No instructions found"}),{success:!1,warrior:null,messages:s};y>t.maxLength&&s.push({type:"ERROR",line:0,text:`Warrior has ${y} instructions, limit is ${t.maxLength}`});let W=[];for(let C=0;C<G.length;C++){let{line:k,text:Q}=G[C];I.set("CURLINE",C);let ae=this.assembleInstruction(Q,C,y,w,A,I,t.coreSize,k,s);ae&&W.push(ae)}if(s.some(C=>C.type==="ERROR"))return{success:!1,warrior:null,messages:s};(f<0||f>=y)&&s.push({type:"WARNING",line:0,text:`ORG/END offset ${f} is outside program bounds (0-${y-1})`});let q=B(f,t.coreSize);return{success:!0,warrior:{instructions:W,startOffset:q,name:n,author:a,strategy:u,pin:c,warnings:s.filter(C=>C.type==="WARNING").map(C=>C.text)},messages:s}}assembleInstruction(e,t,s,r,i,h,n,a,u){let c=this.tokenizeLine(e);if(c.length===0)return null;let f=0,b=c[f].toUpperCase(),d,x=null,T=b.indexOf(".");if(T>=0)d=b.substring(0,T),x=b.substring(T+1),f++;else if(d=b,f++,f<c.length&&c[f].startsWith(".")){let W=c[f].substring(1).toUpperCase();W.length>0?(x=W,f++):(f++,f<c.length&&(x=c[f].toUpperCase(),f++))}let w=J.indexOf(d);if(w<0)return u.push({type:"ERROR",line:a,text:`Unknown opcode: ${d}`}),null;let D=w,I=c.slice(f).join(" "),O=this.splitOperands(I),A=p.DIRECT,R=p.DIRECT,m="0",g="0";if(O.length>=1){let W=this.substituteEquText(O[0].trim(),i,h),q=this.parseOperand(W);A=q.mode,m=q.expr}if(O.length>=2){let W=this.substituteEquText(O[1].trim(),i,h),q=this.parseOperand(W);R=q.mode,g=q.expr}else switch(D){case E.DAT:R=A,g=m,A=p.IMMEDIATE,m="0";break;case E.JMP:case E.SPL:case E.NOP:R=p.DIRECT,g="0";break;default:return u.push({type:"ERROR",line:a,text:`Missing operand for ${d}`}),null}let V;if(x){let W=fe.indexOf(x);if(W<0)return u.push({type:"ERROR",line:a,text:`Unknown modifier: ${x}`}),null;V=W}else V=this.defaultModifier(D,A,R);let Ee=this.substituteLabelsAndEqus(m,t,s,r,i,h,u,a),de=this.substituteLabelsAndEqus(g,t,s,r,i,h,u,a),M=this.evaluator.evaluate(Ee),X=this.evaluator.evaluate(de),G=0,y=0;if(M.ok)G=B(M.value,n),M.overflow&&u.push({type:"WARNING",line:a,text:`A-field expression overflow: ${m}`});else return u.push({type:"ERROR",line:a,text:`Bad A-field expression: ${m} (${M.error})`}),null;if(X.ok)y=B(X.value,n),X.overflow&&u.push({type:"WARNING",line:a,text:`B-field expression overflow: ${g}`});else return u.push({type:"ERROR",line:a,text:`Bad B-field expression: ${g} (${X.error})`}),null;return{opcode:pe(D,V),aMode:A,bMode:R,aValue:G,bValue:y}}parseOperand(e){if(e.length===0)return{mode:p.DIRECT,expr:"0"};let t=e[0],s=K.indexOf(t);return s>=0?{mode:s,expr:e.substring(1).trim()}:{mode:p.DIRECT,expr:e}}splitOperands(e){let t=[],s=0,r="";for(let i of e){if(i==="(")s++;else if(i===")")s--;else if(i===","&&s===0){t.push(r),r="";continue}r+=i}return r.trim()&&t.push(r),t}defaultModifier(e,t,s){switch(e){case E.DAT:case E.NOP:return l.F;case E.MOV:case E.CMP:case E.SEQ:case E.SNE:return t===p.IMMEDIATE?l.AB:s===p.IMMEDIATE?l.B:l.I;case E.ADD:case E.SUB:case E.MUL:case E.DIV:case E.MOD:return t===p.IMMEDIATE?l.AB:s===p.IMMEDIATE?l.B:l.F;case E.SLT:case E.LDP:case E.STP:return t===p.IMMEDIATE?l.AB:l.B;default:return l.B}}substituteLabelsAndEqus(e,t,s,r,i,h,n,a,u){return e.replace(/[A-Za-z_][A-Za-z0-9_]*/g,c=>{let f=c.toUpperCase(),b=h.get(f);if(b!==void 0)return String(b);let d=u??new Set,x=i.get(f);if(x!==void 0){if(d.has(f))return n&&n.push({type:"WARNING",line:a??0,text:`Recursive EQU cycle detected for ${f}`}),"0";let w=new Set(d);return w.add(f),this.substituteLabelsAndEqus(x,t,s,r,i,h,n,a,w)}let T=r.get(f);if(T!==void 0){if(T.isEqu&&T.equText){if(d.has(f))return n&&n.push({type:"WARNING",line:a??0,text:`Recursive EQU cycle detected for ${f}`}),"0";let w=new Set(d);return w.add(f),this.substituteLabelsAndEqus(T.equText,t,s,r,i,h,n,a,w)}return String(T.value-t)}return c.length===1?c:(n&&n.push({type:"WARNING",line:a??0,text:`Undefined symbol: ${c}`}),"0")})}substituteLabelsAndEqusAbsolute(e,t,s,r,i){return e.replace(/[A-Za-z_][A-Za-z0-9_]*/g,h=>{let n=h.toUpperCase(),a=r.get(n);if(a!==void 0)return String(a);let u=i??new Set,c=s.get(n);if(c!==void 0){if(u.has(n))return"0";let b=new Set(u);return b.add(n),this.substituteLabelsAndEqusAbsolute(c,t,s,r,b)}let f=t.get(n);if(f!==void 0){if(f.isEqu&&f.equText){if(u.has(n))return"0";let b=new Set(u);return b.add(n),this.substituteLabelsAndEqusAbsolute(f.equText,t,s,r,b)}return String(f.value)}return h.length===1?h:"0"})}substituteEquText(e,t,s,r){return e.replace(/[A-Za-z_][A-Za-z0-9_]*/g,i=>{let h=i.toUpperCase();if(t.has(h)){let n=r??new Set;if(n.has(h))return i;let a=new Set(n);return a.add(h),this.substituteEquText(t.get(h),t,s,a)}return s.has(h)?String(s.get(h)):i})}substituteEqus(e,t,s,r){return e.replace(/[A-Za-z_][A-Za-z0-9_]*/g,i=>{let h=i.toUpperCase();if(s.has(h))return String(s.get(h));if(t.has(h)){let n=r??new Set;if(n.has(h))return"0";let a=new Set(n);return a.add(h),this.substituteEqus(t.get(h),t,s,a)}return i.length===1?i:"0"})}substituteAmpersand(e,t,s,r){return e.replace(/&([A-Za-z_][A-Za-z0-9_]*)/g,(i,h)=>{let n=h.toUpperCase();if(r.has(n)&&t.has(n)){let a=t.get(n),u=parseInt(a,10);return!isNaN(u)&&String(u)===a?String(u).padStart(2,"0"):a}return"&"+h})}expandNestedFor(e,t,s){let r=[],i=0;for(;i<e.length;)if(e[i].toUpperCase().trim().startsWith("FOR")){let n=this.tokenizeLine(e[i]),a=null,u=0;for(;u<n.length&&n[u].toUpperCase()!=="FOR";){let I=n[u];I.endsWith(":")&&(I=I.slice(0,-1)),a=I.toUpperCase(),u++}let c=n.slice(u+1).join(" "),f=this.substituteEqus(c,t,s),b=this.evaluator.evaluate(f),d=(b.ok?b.value:0)&65535,x=1,T=[];for(i++;i<e.length&&x>0;){let D=e[i].toUpperCase().trim();if(D.startsWith("ROF")&&(x--,x===0)){i++;break}D.startsWith("FOR")&&x++,T.push(e[i]),i++}let w=this.expandNestedFor(T,t,s);for(let D=1;D<=d;D++){a&&t.set(a,String(D));for(let I of w)r.push(I)}}else r.push(e[i]),i++;return r}expandMultiLineEqus(e,t){let s=[];for(let r of e){let i=r.text.trim().toUpperCase();if(t.has(i)&&t.get(i).length>1){let h=t.get(i);for(let n of h)s.push({line:r.line,text:n,rawLine:r.rawLine})}else s.push(r)}return s}tokenizeLine(e){let t=[],s=0;for(;s<e.length;){for(;s<e.length&&(e[s]===" "||e[s]==="	");)s++;if(s>=e.length)break;let r="",i=e[s];if(i===","||i==="."||i==="#"||i==="$"||i==="@"||i==="<"||i===">"||i==="*"||i==="{"||i==="}"){if(r=i,s++,"#$@<>*{}".includes(i)){t.push(r);continue}if(i==="."){for(;s<e.length&&/[A-Za-z]/.test(e[s]);)r+=e[s],s++;t.push(r);continue}t.push(r);continue}if(/[A-Za-z0-9_]/.test(i)){for(;s<e.length&&/[A-Za-z0-9_:]/.test(e[s]);)r+=e[s],s++;if(s<e.length&&e[s]===".")for(r+=".",s++;s<e.length&&/[A-Za-z]/.test(e[s]);)r+=e[s],s++;t.push(r);continue}if(i==="|"&&s+1<e.length&&e[s+1]==="|"){t.push("||"),s+=2;continue}if(i==="&"&&s+1<e.length&&e[s+1]==="&"){t.push("&&"),s+=2;continue}if("()+-/%!=|& ".includes(i)){r=i,s++,t.push(r);continue}s++}return t}isOpcode(e){return J.includes(e)||e.includes(".")&&J.includes(e.split(".")[0])}};function Ne(o,e){let{opcode:t,modifier:s}=ee(o.opcode),r=J[t]||"???",i=fe[s]||"??",h=K[o.aMode]||"$",n=K[o.bMode]||"$",a=u=>u>e/2?u-e:u;return`${r}.${i} ${h}${a(o.aValue)}, ${n}${a(o.bValue)}`}return Ue(Be);})();
</script>
<script>
(function() {
    const COLS = 100;
    const ROWS = 80;
    const CELL_SIZE = 4;
    const WIDTH = COLS * CELL_SIZE;
    const HEIGHT = ROWS * CELL_SIZE;
    const CORE_SIZE = 8000;
    const NUM_WARRIORS = 2;
    const TARGET_SECONDS = 18;
    const TARGET_FRAMES = TARGET_SECONDS * 60;
    const MAX_FRAME_SKIP = 10;

    const COLORS = {
        empty:     [10, 10, 15],
        challengerTerritory: [10, 74, 10],
        challengerFading:    [30, 160, 15],
        challengerActive:    [57, 255, 20],
        defenderTerritory:   [58, 0, 58],
        defenderFading:      [160, 0, 160],
        defenderActive:      [255, 0, 255],
    };

    const canvas = document.getElementById('core');
    canvas.width = WIDTH;
    canvas.height = HEIGHT;
    const ctx = canvas.getContext('2d');
    const imageData = ctx.createImageData(WIDTH, HEIGHT);

    const statusEl = document.getElementById('status');
    const cycleEl = document.getElementById('cycle-display');
    const challengerTasksEl = document.getElementById('challenger-tasks');
    const defenderTasksEl = document.getElementById('defender-tasks');
    const progressFill = document.getElementById('progress-fill');
    const winnerBanner = document.getElementById('winner-banner');
    const btnPlay = document.getElementById('btn-play');
    const btnStep = document.getElementById('btn-step');
    const btnEnd = document.getElementById('btn-end');

    let territoryMap = new Uint8Array(CORE_SIZE);
    let activityMap = new Uint8Array(CORE_SIZE);
    let simulator = null;
    let stepCount = 0;
    let currentCycle = 0;
    let maxCycles = 80000;
    let totalSteps = 0;
    let roundEnded = false;
    let roundWinner = null;
    let challengerTasks = 0;
    let defenderTasks = 0;
    let endCycle = null;
    let playing = false;
    let rafId = null;
    let cyclesPerFrame = 100;
    let frameSkip = 1;
    let frameCount = 0;
    let challengerName = 'Challenger';
    let defenderName = 'Defender';

    const pendingEvents = [];
    const eventListener = {
        onCoreAccess(events) {
            for (const e of events) {
                pendingEvents.push({ warriorId: e.warriorId, address: e.address, accessType: e.accessType });
            }
        },
        onTaskCount(counts) {
            for (const c of counts) {
                if (c.warriorId === 0) challengerTasks = c.taskCount;
                else defenderTasks = c.taskCount;
            }
        },
        onRoundEnd(event) {
            roundEnded = true;
            if (event.winnerId !== null) {
                roundWinner = event.winnerId === 0 ? 'challenger' : 'defender';
            } else {
                roundWinner = 'tie';
            }
        }
    };

    function renderCanvas() {
        const data = imageData.data;
        for (let i = 0; i < CORE_SIZE; i++) {
            const territory = territoryMap[i];
            const activity = activityMap[i];
            let color;
            if (territory === 1) {
                if (activity >= 2) color = COLORS.challengerActive;
                else if (activity === 1) color = COLORS.challengerFading;
                else color = COLORS.challengerTerritory;
            } else if (territory === 2) {
                if (activity >= 2) color = COLORS.defenderActive;
                else if (activity === 1) color = COLORS.defenderFading;
                else color = COLORS.defenderTerritory;
            } else {
                if (activity >= 2) color = COLORS.challengerActive;
                else if (activity === 1) color = COLORS.challengerFading;
                else color = COLORS.empty;
            }
            const col = i % COLS;
            const row = Math.floor(i / COLS);
            for (let dy = 0; dy < CELL_SIZE; dy++) {
                for (let dx = 0; dx < CELL_SIZE; dx++) {
                    const px = (row * CELL_SIZE + dy) * WIDTH + (col * CELL_SIZE + dx);
                    const offset = px * 4;
                    data[offset] = color[0];
                    data[offset + 1] = color[1];
                    data[offset + 2] = color[2];
                    data[offset + 3] = 255;
                }
            }
        }
        ctx.putImageData(imageData, 0, 0);
    }

    function processEvents() {
        // Decay activity
        for (let i = 0; i < CORE_SIZE; i++) {
            if (activityMap[i] > 0) activityMap[i]--;
        }
        // Apply new events
        for (const event of pendingEvents) {
            const addr = event.address % CORE_SIZE;
            if (event.accessType === 'WRITE') {
                territoryMap[addr] = event.warriorId === 0 ? 1 : 2;
            }
            activityMap[addr] = 3;
            if (event.accessType === 'EXECUTE' && territoryMap[addr] === 0) {
                territoryMap[addr] = event.warriorId === 0 ? 1 : 2;
            }
        }
        pendingEvents.length = 0;
    }

    function advanceCycles(count) {
        pendingEvents.length = 0;
        const stepsToRun = count * NUM_WARRIORS;
        for (let i = 0; i < stepsToRun && !roundEnded && stepCount < totalSteps; i++) {
            simulator.step();
            stepCount++;
        }
        currentCycle = Math.floor(stepCount / NUM_WARRIORS);
        processEvents();
        updateUI();
    }

    function runToEnd() {
        pendingEvents.length = 0;
        const remaining = totalSteps - stepCount;
        for (let i = 0; i < remaining && !roundEnded; i++) {
            simulator.step();
            stepCount++;
        }
        currentCycle = Math.floor(stepCount / NUM_WARRIORS);
        processEvents();
        updateUI();
        checkRoundEnd();
    }

    function updateUI() {
        cycleEl.textContent = 'Cycle: ' + formatNumber(currentCycle);
        challengerTasksEl.textContent = challengerName + ': ' + challengerTasks;
        defenderTasksEl.textContent = defenderName + ': ' + defenderTasks;
        const effectiveMax = endCycle || maxCycles;
        const pct = effectiveMax > 0 ? (currentCycle / effectiveMax) * 100 : 0;
        progressFill.style.width = Math.min(100, pct) + '%';
        renderCanvas();
    }

    function checkRoundEnd() {
        if (roundEnded || stepCount >= totalSteps) {
            playing = false;
            if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
            btnPlay.textContent = 'Play';
            btnPlay.disabled = true;
            btnStep.disabled = true;
            btnEnd.disabled = true;

            const winner = roundWinner || 'tie';
            winnerBanner.style.display = 'block';
            if (winner === 'challenger') {
                winnerBanner.textContent = challengerName.toUpperCase() + ' WINS';
                winnerBanner.style.color = '#39ff14';
            } else if (winner === 'defender') {
                winnerBanner.textContent = defenderName.toUpperCase() + ' WINS';
                winnerBanner.style.color = '#ff00ff';
            } else {
                winnerBanner.textContent = 'TIE';
                winnerBanner.style.color = '#88ccff';
            }
        }
    }

    function formatNumber(n) {
        return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
    }

    function tick() {
        if (!playing) return;
        frameCount++;
        if (frameCount % frameSkip === 0) {
            advanceCycles(cyclesPerFrame);
            if (roundEnded || stepCount >= totalSteps) {
                checkRoundEnd();
                return;
            }
        }
        rafId = requestAnimationFrame(tick);
    }

    btnPlay.addEventListener('click', () => {
        if (playing) {
            playing = false;
            if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
            btnPlay.textContent = 'Play';
        } else {
            playing = true;
            btnPlay.textContent = 'Pause';
            rafId = requestAnimationFrame(tick);
        }
    });

    btnStep.addEventListener('click', () => {
        if (!playing) {
            advanceCycles(1);
            if (roundEnded || stepCount >= totalSteps) checkRoundEnd();
        }
    });

    btnEnd.addEventListener('click', () => {
        playing = false;
        if (rafId) { cancelAnimationFrame(rafId); rafId = null; }
        btnPlay.textContent = 'Play';
        runToEnd();
    });

    // Called from Swift via evaluateJavaScript
    window.loadReplay = function(replayData, roundNumber) {
        try {
            statusEl.textContent = 'INITIALIZING...';
            const settings = replayData.settings;
            maxCycles = settings.maxCycles;
            totalSteps = maxCycles * NUM_WARRIORS;

            challengerName = replayData.challenger.name;
            defenderName = replayData.defender.name;

            const roundData = replayData.round_results
                ? replayData.round_results.find(r => r.round === roundNumber)
                : (replayData.roundResults || []).find(r => r.round === roundNumber);

            if (!roundData) {
                statusEl.textContent = 'Round ' + roundNumber + ' not found';
                return;
            }

            const { Assembler, Simulator } = PmarsTS;

            const assembler = new Assembler({
                coreSize: settings.coreSize,
                maxCycles: settings.maxCycles,
                maxLength: settings.maxLength,
                maxProcesses: settings.maxTasks,
                minSeparation: settings.minSeparation,
            });

            const challengerResult = assembler.assemble(replayData.challenger.redcode);
            const defenderResult = assembler.assemble(replayData.defender.redcode);

            if (!challengerResult.success || !defenderResult.success) {
                statusEl.textContent = 'ASSEMBLY ERROR';
                return;
            }

            // Prescan: run to completion to find end cycle
            statusEl.textContent = 'SCANNING BATTLE...';

            const prescanSim = new Simulator({
                coreSize: settings.coreSize,
                maxCycles: settings.maxCycles,
                maxLength: settings.maxLength,
                maxProcesses: settings.maxTasks,
                minSeparation: settings.minSeparation,
                seed: roundData.seed,
            });
            prescanSim.loadWarriors([challengerResult.warrior, defenderResult.warrior]);

            // Fast-forward prior rounds for pspace
            const roundIndex = roundNumber - 1;
            if (roundIndex > 0) {
                for (let i = 0; i < roundIndex; i++) prescanSim.runRound();
            }
            prescanSim.setupRound();

            let prescanSteps = 0;
            let prescanEnded = false;
            const prescanTotal = maxCycles * NUM_WARRIORS;
            prescanSim.setEventListener({
                onCoreAccess() {},
                onTaskCount() {},
                onRoundEnd() { prescanEnded = true; }
            });
            while (prescanSteps < prescanTotal && !prescanEnded) {
                prescanSim.step();
                prescanSteps++;
            }
            const scanEndCycle = Math.floor(prescanSteps / NUM_WARRIORS);

            // Now create the real simulator for playback
            simulator = new Simulator({
                coreSize: settings.coreSize,
                maxCycles: settings.maxCycles,
                maxLength: settings.maxLength,
                maxProcesses: settings.maxTasks,
                minSeparation: settings.minSeparation,
                seed: roundData.seed,
            });
            simulator.loadWarriors([challengerResult.warrior, defenderResult.warrior]);

            if (roundIndex > 0) {
                for (let i = 0; i < roundIndex; i++) simulator.runRound();
            }
            simulator.setEventListener(eventListener);
            simulator.setupRound();

            // Reset state
            territoryMap = new Uint8Array(CORE_SIZE);
            activityMap = new Uint8Array(CORE_SIZE);
            stepCount = 0;
            currentCycle = 0;
            roundEnded = false;
            roundWinner = null;
            challengerTasks = 0;
            defenderTasks = 0;
            playing = false;
            frameCount = 0;
            endCycle = scanEndCycle;

            // Calculate playback speed
            if (scanEndCycle <= TARGET_FRAMES) {
                cyclesPerFrame = 1;
                frameSkip = Math.min(MAX_FRAME_SKIP, Math.max(1, Math.round(TARGET_FRAMES / scanEndCycle)));
            } else {
                cyclesPerFrame = Math.ceil(scanEndCycle / TARGET_FRAMES);
                frameSkip = 1;
            }

            // Enable controls
            btnPlay.disabled = false;
            btnStep.disabled = false;
            btnEnd.disabled = false;
            btnPlay.textContent = 'Play';
            winnerBanner.style.display = 'none';
            statusEl.textContent = challengerName + ' vs ' + defenderName + ' â€” Round ' + roundNumber;

            updateUI();

            // Auto-play
            playing = true;
            btnPlay.textContent = 'Pause';
            rafId = requestAnimationFrame(tick);

        } catch(err) {
            statusEl.textContent = 'ERROR: ' + err.message;
            console.error(err);
        }
    };

    // Initial render
    renderCanvas();
})();
</script>
</body>
</html>
